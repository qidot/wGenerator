<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>æ–­ç‚¹ä¸Šä¼ </title>
    <link rel="stylesheet" type="text/css" href="css/webuploader.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"
          integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
</head>
<body>
<div id="uploader" class="wu-example">
    <!--ç”¨æ¥å­˜æ”¾æ–‡ä»¶ä¿¡æ¯-->
    <div id="thelist" class="uploader-list"></div>
    <div class="btns">
        <div id="picker">é€‰æ‹©å¤§æ–‡ä»¶</div>
        <button id="ctlBtn" class="btn btn-default">å¼€å§‹ä¸Šä¼ </button>
    </div>
</div>
<!--å¼•å…¥JS-->
<script src="http://cdn.bootcss.com/jquery/1.12.4/jquery.min.js"></script>
<script type="text/javascript" src="js/webuploader.min.js"></script>
<script>
    var $btn = $('#ctlBtn');
    var $thelist = $('#thelist');
    var chunkSize = 5 * 1024 * 1024;

    // HOOK è¿™ä¸ªå¿…é¡»è¦å†uploaderå®ä¾‹åŒ–å‰é¢
    WebUploader.Uploader.register({
        'before-send-file': 'beforeSendFile',
        'before-send': 'beforeSend'
    }, {
        beforeSendFile: function (file) {
            //console.log("beforeSendFile");
            // Deferredå¯¹è±¡åœ¨é’©å­å›æ‰å‡½æ•°ä¸­ç»å¸¸è¦ç”¨åˆ°ï¼Œç”¨æ¥å¤„ç†éœ€è¦ç­‰å¾…çš„å¼‚æ­¥æ“ä½œã€‚
            var task = new $.Deferred();
            // æ ¹æ®æ–‡ä»¶å†…å®¹æ¥æŸ¥è¯¢MD5
            uploader.md5File(file).progress(function (percentage) {   // åŠæ—¶æ˜¾ç¤ºè¿›åº¦
                //console.log('è®¡ç®—md5è¿›åº¦:', percentage);
                getProgressBar(file, percentage, "MD5", "MD5");
            }).then(function (val) { // å®Œæˆ
                //console.log('md5 result:', val);
                file.md5 = val;
                // æ¨¡æ‹Ÿç”¨æˆ·id
                // file.uid = new Date().getTime() + "_" + Math.random() * 100;
                file.uid = WebUploader.Base.guid();
                // è¿›è¡Œmd5åˆ¤æ–­
                $.ajax({
		            url:"/checkFileMd5",
		            type:"POST",
		            data:{uid: file.uid, md5: file.md5},
		            beforeSend: function(request) {
		                request.setRequestHeader("Authorization","Bearer "+getToken());
		            },
		            contentType:"application/json;charset=utf-8", //ç¼ºå¤±ä¼šå‡ºç°URLç¼–ç ï¼Œæ— æ³•è½¬æˆjsonå¯¹è±¡
		            statusCode:{
		                401:function(xhr) {
		                    alert("First login ğŸ‘Œï¼Ÿ");
		                }
		            },
		            success:function(data){
		            	//console.log(data);
                        var status = data.data;
                        task.resolve();
                        if (status == 101) {
                            // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œé‚£å°±æ­£å¸¸æµç¨‹
                        } else if (status == 100) {
                            // å¿½ç•¥ä¸Šä¼ è¿‡ç¨‹ï¼Œç›´æ¥æ ‡è¯†ä¸Šä¼ æˆåŠŸï¼›
                            uploader.skipFile(file);
                            file.pass = true;
                        } else if (status == 102) {
                            // éƒ¨åˆ†å·²ç»ä¸Šä¼ åˆ°æœåŠ¡å™¨äº†ï¼Œä½†æ˜¯å·®å‡ ä¸ªæ¨¡å—ã€‚
                            file.missChunks = data.data;
                        }
		            }
		        });
            });
            return $.when(task);
        },
        beforeSend: function (block) {
            //console.log("block")
            var task = new $.Deferred();
            var file = block.file;
            var missChunks = file.missChunks;
            var blockChunk = block.chunk;
            //console.log("å½“å‰åˆ†å—ï¼š" + blockChunk);
            //console.log("missChunks:" + missChunks);
            if (missChunks !== null && missChunks !== undefined && missChunks !== '') {
                var flag = true;
                for (var i = 0; i < missChunks.length; i++) {
                    if (blockChunk == missChunks[i]) {
                        //console.log(file.name + ":" + blockChunk + ":è¿˜æ²¡ä¸Šä¼ ï¼Œç°åœ¨ä¸Šä¼ å»å§ã€‚");
                        flag = false;
                        break;
                    }
                }
                if (flag) {
                    task.reject();
                } else {
                    task.resolve();
                }
            } else {
                task.resolve();
            }
            return $.when(task);
        }
    });
	var headers = {};
	headers.Authorization = "Bearer "+getToken();
    // å®ä¾‹åŒ–
    var uploader = WebUploader.create({
        pick: {
            id: '#picker',
            label: 'ç‚¹å‡»é€‰æ‹©æ–‡ä»¶'
        },
        formData: {
            uid: 0,
            md5: '',
            chunkSize: chunkSize
        },
        //dnd: '#dndArea',
        //paste: '#uploader',
        swf: 'js/Uploader.swf',
        chunked: true,
        chunkSize: chunkSize, // å­—èŠ‚ 1Måˆ†å—
        threads: 3,
        server: '/fileUpload',
        headers: headers,
        auto: false,

        // ç¦æ‰å…¨å±€çš„æ‹–æ‹½åŠŸèƒ½ã€‚è¿™æ ·ä¸ä¼šå‡ºç°å›¾ç‰‡æ‹–è¿›é¡µé¢çš„æ—¶å€™ï¼ŒæŠŠå›¾ç‰‡æ‰“å¼€ã€‚
        disableGlobalDnd: true,
        fileNumLimit: 1024,
        fileSizeLimit: 1024 * 1024 * 1024,    // 200 M
        fileSingleSizeLimit: 1024 * 1024 * 1024    // 50 M
    });

    // å½“æœ‰æ–‡ä»¶è¢«æ·»åŠ è¿›é˜Ÿåˆ—çš„æ—¶å€™
    uploader.on('fileQueued', function (file) {
        //console.log("fileQueued");
        $thelist.append('<div id="' + file.id + '" class="item">' +
                '<h4 class="info">' + file.name + '</h4>' +
                '<p class="state">ç­‰å¾…ä¸Šä¼ ...</p>' +
                '</div>');
    });

    //å½“æŸä¸ªæ–‡ä»¶çš„åˆ†å—åœ¨å‘é€å‰è§¦å‘ï¼Œä¸»è¦ç”¨æ¥è¯¢é—®æ˜¯å¦è¦æ·»åŠ é™„å¸¦å‚æ•°ï¼Œå¤§æ–‡ä»¶åœ¨å¼€èµ·åˆ†ç‰‡ä¸Šä¼ çš„å‰æä¸‹æ­¤äº‹ä»¶å¯èƒ½ä¼šè§¦å‘å¤šæ¬¡ã€‚
    uploader.onUploadBeforeSend = function (obj, data) {
        //console.log("onUploadBeforeSend");
        var file = obj.file;
        data.md5 = file.md5 || '';
        data.uid = file.uid;
    };
    // ä¸Šä¼ ä¸­
    uploader.on('uploadProgress', function (file, percentage) {
        getProgressBar(file, percentage, "FILE", "ä¸Šä¼ è¿›åº¦");
    });
    // ä¸Šä¼ è¿”å›ç»“æœ
    uploader.on('uploadSuccess', function (file) {
        var text = 'å·²ä¸Šä¼ ';
        if (file.pass) {
            text = "æ–‡ä»¶å¦™ä¼ åŠŸèƒ½ï¼Œæ–‡ä»¶å·²ä¸Šä¼ ã€‚"
        }
        $('#' + file.id).find('p.state').text(text);
    });
    uploader.on('uploadError', function (file) {
        $('#' + file.id).find('p.state').text('ä¸Šä¼ å‡ºé”™');
    });
    uploader.on('uploadComplete', function (file) {
        // éšè—è¿›åº¦æ¡
        // fadeOutProgress(file, 'MD5');
        // fadeOutProgress(file, 'FILE');
    });
    // æ–‡ä»¶ä¸Šä¼ 
    $btn.on('click', function () {
        //console.log("ä¸Šä¼ ...");
        uploader.upload();
        //console.log("ä¸Šä¼ æˆåŠŸ");
    });

    /**
     *  ç”Ÿæˆè¿›åº¦æ¡å°è£…æ–¹æ³•
     * @param file æ–‡ä»¶
     * @param percentage è¿›åº¦å€¼
     * @param id_Prefix idå‰ç¼€
     * @param titleName æ ‡é¢˜å
     */
    function getProgressBar(file, percentage, id_Prefix, titleName) {
        var $li = $('#' + file.id), $percent = $li.find('#' + id_Prefix + '-progress-bar');
        // é¿å…é‡å¤åˆ›å»º
        if (!$percent.length) {
            $percent = $('<div id="' + id_Prefix + '-progress" class="progress progress-striped active">' +
                    '<div id="' + id_Prefix + '-progress-bar" class="progress-bar" role="progressbar" style="width: 0%">' +
                    '</div>' +
                    '</div>'
            ).appendTo($li).find('#' + id_Prefix + '-progress-bar');
        }
        var progressPercentage = percentage * 100 + '%';
        $percent.css('width', progressPercentage);
        $percent.html(titleName + ':' + progressPercentage);
    }

    /**
     * éšè—è¿›åº¦æ¡
     * @param file æ–‡ä»¶å¯¹è±¡
     * @param id_Prefix idå‰ç¼€
     */
    function fadeOutProgress(file, id_Prefix) {
        $('#' + file.id).find('#' + id_Prefix + '-progress').fadeOut();
    }
    function getToken() {
        return  localStorage.getItem("token");
    }
</script>
</body>
</html>